<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventory Management System â€“ INVENTORY02 (Final)</title>
<style>

.materials-scroll{
  max-height:70vh;
  overflow-y:auto;
}


.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-top:20px;
}

.circle-card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  text-align:center;
  cursor:pointer;
}

.circle{
  width:140px;
  height:140px;
  border-radius:50%;
  background:conic-gradient(var(--muted) 0deg,#0b2e40 0deg);
  display:flex;
  align-items:center;
  justify-content:center;
  margin:10px auto;
}

.circle span{
  font-size:26px;
  font-weight:600;
}


  :root{
    --bg:#093851; --card:#153a4e; --muted:#0cf0ff; --accent:#2d607c; --danger:#aa3333; --panel:#07456552;
    --text:#0cf0ff; --light:#0cf0ff;
  }
  html,body{
  height:100%;
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow:auto;
}

  .dark { background:#061121; color:var(--muted); }

/* FIX edit modal unit dropdown */
#editUnit{
  display:block;
  width:100%;
  height:38px;
  line-height:38px;
  padding:6px 10px;
  background:#0b2e40;
  color:var(--text);
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.15);
  overflow:hidden;
  appearance:auto;
  -webkit-appearance:menulist;
  -moz-appearance:menulist;
}


  /* LOGIN */
  #loginPage{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg); z-index:99999}
  .centerBox{width:420px; padding:36px; background:var(--panel); border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.25)}
  .centerBox h2{margin:0 0 18px; text-align:center; font-weight:400}
  input, select, button{padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); font-size:14px; width:100%; box-sizing:border-box; background:transparent; color:var(--text)}
  button.action{background:var(--accent); color:var(--light); border:none; cursor:pointer}
  a.link{color:var(--muted); cursor:pointer; display:block; text-align:center; margin-top:14px}

  /* LAYOUT */
  #sidebar{width:230px; height:100vh; background:var(--panel); color:#0cf0ff; display:none; flex-direction:column; padding:20px 0; position:fixed; left:0; top:0; box-sizing:border-box}
  #sidebar h2{margin:0 0 18px; text-align:center; font-weight:400}
  .sidebar-btn{padding:14px 18px; background:none; border:none; color:#0cf0ff; font-size:15px; text-align:left; cursor:pointer; width:100%}
  .sidebar-btn:hover, .sidebar-btn.active{background:#09243e}

  #main{margin-left:230px; height:100vh; overflow-y:auto; padding:28px; display:none}
  .card{background:var(--card); padding:22px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.12); max-width:1100px; margin:auto}
  .dark .card{background:#131b28}

  table{width:100%; border-collapse:collapse; margin-top:12px; color:var(--light)}
  th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; font-size:14px}
  th{opacity:0.9}

  .actionSmall{padding:8px 10px; border-radius:6px; background:rgba(255,255,255,0.05); color:var(--light); border:1px solid rgba(255,255,255,0.04); cursor:pointer}

  /* MODALS */
  .modal-overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:90000}
  .modalContent{
  background:var(--card);
  padding:20px;
  width:420px;
  border-radius:10px;
  box-shadow:0 10px 40px rgba(0,0,0,0.4);

  max-height:85vh;        /* âœ… LIMIT HEIGHT */
  overflow-y:auto;        /* âœ… ENABLE SCROLL */
}

  .modalContent h3{margin-top:0; color:var(--light)}
  .modalContent input{
  width:100%;
  padding:8px;
  border-radius:6px;
  margin-top:6px;
  background:transparent;
  color:var(--text);
  border:1px solid rgba(255,255,255,0.06);
}

.modalContent select{
  width:100%;
  padding:8px;
  border-radius:6px;
  margin-top:6px;
  background:#0b2e40;
  color:var(--text);
  border:1px solid rgba(255,255,255,0.12);
  appearance:auto;
}

  .modalFooter{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .btn-delete{background:var(--danger); color:white; border:none; padding:10px 12px; border-radius:8px; cursor:pointer}
  .btn-cancel{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:8px; cursor:pointer}

  #confirmModal .modalContent{width:320px; text-align:center}
  #confirmModal .modalMessage{margin:10px 0 0; font-size:14px; color:var(--light)}

  /* Success popup specifics */
  #successModal .modalContent{ width:420px; text-align:left; }
  #successModal h3 { color: #8affc1; text-align:center; margin:0; }

  label{display:block; font-size:12px; color:#cfeef0; margin-top:8px}
  .hidden{display:none}

  @media(max-width:900px){
  #sidebar{display:none !important}
  #main{margin-left:0; padding:16px}
  .modalContent{
    width:92%;
    max-height:85vh;   /* âœ… ENSURE SCROLL ON MOBILE */
    overflow-y:auto;
  }
}

  /* small status */
  #statusBar{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.45);color:#a7c5ff;padding:8px 12px;border-radius:8px;font-size:13px;z-index:99999}

  /* animation */
  .modalContent { transform-origin:center; animation:modalIn .14s ease-out; }
  @keyframes modalIn { from{opacity:0; transform:scale(0.98);} to{opacity:1; transform:scale(1);} }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="centerBox">
    <h2>Login</h2>
    <input id="loginUser" placeholder="Username" list="userList"><br><br>
    <datalist id="userList"></datalist>
    <input id="loginPass" type="password" placeholder="Password"><br><br>
    <button class="action" onclick="login()">Login</button>
    <a class="link" id="createAccountLink" onclick="showCreate()">Create Account</a>

  </div>
</div>

<!-- CREATE -->
<div id="createPage" style="display:none;position:fixed;inset:0;background:var(--bg);justify-content:center;align-items:center;z-index:99999">
  <div class="centerBox">
    <h2>Create Account</h2>
    <input id="newUser" placeholder="Username"><br><br>
    <input id="newPass" type="password" placeholder="Password"><br><br>
    <input id="newKey" placeholder="Invite Key"><br><br>
    <button class="action" onclick="createAccount()">Create</button>
    <a class="link" onclick="showLogin()">Back to Login</a>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">

  <div id="sidebarUser" style="
    text-align:center;
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,255,255,0.08);
  ">
    <div id="sidebarUsername" style="font-size:16px;font-weight:500;">
      â€”
    </div>
    <div id="sidebarRole" style="font-size:12px;opacity:.75;">
      â€”
    </div>
  </div>

  <h2>Menu</h2>


  <button class="sidebar-btn" onclick="showPage('dashboard')" id="sb_dashboard">
  Dashboard
</button>
  <button class="sidebar-btn" onclick="showPage('inventory')" id="sb_inventory">Inventory</button>
  <button class="sidebar-btn" onclick="showPage('materials')" id="sb_materials">Materials</button>
  <button class="sidebar-btn" onclick="showPage('restock')" id="sb_restock">Restock</button>
  <button class="sidebar-btn" onclick="showPage('checkout')" id="sb_checkout">Checkout</button>
  <button class="sidebar-btn" onclick="showPage('activity')" id="sb_activity">Activity Log</button>
  <button class="sidebar-btn" onclick="showPage('settings')" id="sb_settings">Settings</button>
<button class="sidebar-btn adminOnly" onclick="showPage('admin')" id="sb_admin">
  Admin
</button>

</div>

<!-- MAIN -->
<div id="main">

<div id="admin" class="card" style="display:none;">
  <h2>Admin Panel</h2>

  <div id="roleManager" class="hidden">
    <h3>User Roles</h3>

    <select id="roleUserSelect"></select>

    <select id="roleSelect" style="margin-top:8px;">
  <option value="user">User</option>
  <option value="microbiologist">Microbiologist</option>
  <option value="admin">Admin</option>
  <option value="superadmin">Super Admin</option>
</select>


    <button class="action" style="margin-top:10px;" onclick="changeUserRole()">
      Update Role
    </button>
  </div>

  <hr>

  <div id="adminPanel" class="hidden">
  <h3>Admin Controls</h3>

  <label>Key Role</label>
  <select id="keyRoleSelect" style="margin-top:6px;">
    <option value="user">User</option>
    <option value="microbiologist" selected>Microbiologist</option>
    <option value="admin">Admin</option>
  </select>

  <button class="action" style="margin-top:10px;" onclick="generateKey()">
    Generate Key
  </button><br><br>


    <label>
      <input type="checkbox" onchange="toggleCreateAccounts(this.checked)">
      Disable Create Account
    </label>

    <h4 style="margin-top:14px;">Key Log</h4>
    <div id="keyLog" style="font-size:13px;opacity:.85"></div>
  </div>
</div>


<div id="dashboard" class="card" style="display:none;">
  <h2>Dashboard</h2>

  <div class="dashboard-grid">

    <div class="circle-card" onclick="openDashPopup('low')">
      <h3>Low Stock</h3>
      <div class="circle" id="circle_low">
        <span id="dash_low">0</span>
      </div>
    </div>

    <div class="circle-card" onclick="openDashPopup('exp')">
      <h3>Expiring Soon</h3>
      <div class="circle" id="circle_exp">
        <span id="dash_exp">0</span>
      </div>
    </div>

    <div class="circle-card">
      <h3>Total Items</h3>
      <div class="circle" id="circle_items">
        <span id="dash_items">0</span>
      </div>
    </div>

<div class="circle-card" onclick="openDashPopup('users')">
  <h3>Users</h3>
  <div class="circle" id="circle_users">
    <span id="dash_users">0</span>
  </div>
</div>


  </div>
</div>


  <div id="inventory" class="card" style="display:none;">
    <h2>Inventory</h2>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Lot</th><th>Exp</th><th>Qty</th><th>Volume</th><th>Unit</th></tr></thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>

  <div id="materials" class="card" style="display:none;">
  <h2>Materials</h2>

  <div class="materials-scroll">
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Lot</th><th>Exp</th><th>Qty</th><th>Volume</th><th>Unit</th><th>Action</th></tr></thead>
      <tbody id="materialsTable"></tbody>
    </table>
  </div>
</div>

  <div id="restock" class="card" style="display:none;">
    <h2>Restock Item</h2>
    <input id="r_itemNum" placeholder="Item Number"><br>
    <input id="r_name" placeholder="Name" style="margin-top:10px;"><br>
    <input id="r_lot" placeholder="Lot" style="margin-top:10px;"><br>
    <input id="r_exp" type="date" style="margin-top:10px;"><br>

    <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
      <input id="r_qty" placeholder="Quantity to add" type="number" style="flex:1;">
      <input id="r_volume" placeholder="Volume per item (numeric, optional)" type="number" style="width:160px;">
      <select id="r_unit" style="width:120px;">
  <option value="">(none)</option>
  <option value="mL">mL</option>
  <option value="L">L</option>
  <option value="mg">mg</option>
  <option value="g">g</option>
  <option value="kg">kg</option>
  <option value="mm">mm</option>
  <option value="Units">Units</option>
</select>
</div>


    <div style="margin-top:12px;color:#cfeef0;font-size:13px">Note: Quantity = number of containers. Volume = amount per container (optional).</div>
    <button class="action" onclick="restock()" style="margin-top:14px;">Restock</button>
  </div>

  <div id="checkout" class="card" style="display:none;">
    <h2>Checkout</h2>
    <div style="display:flex;gap:20px;align-items:flex-start;">
      <div style="flex:1;">
        <input id="c_search" placeholder="Search (name, number, or lot)" oninput="updateDropdown()"><br>
        <select id="c_dropdown" size="5" style="margin-top:10px;width:100%;display:none;" onchange="selectItem()"></select>

        <h3 style="margin-top:18px;">Details</h3>
        <input id="c_itemNum" placeholder="Item Number" readonly><br>
        <input id="c_name" placeholder="Name" readonly style="margin-top:10px;"><br>
        <input id="c_lot" placeholder="Lot" readonly style="margin-top:10px;"><br>
        <input id="c_exp" placeholder="Exp" readonly style="margin-top:10px;"><br>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
          <input id="c_qty" placeholder="Qty to checkout" type="number" style="flex:1;">
          <input id="c_volume" placeholder="Volume" readonly style="width:110px;">
          <input id="c_unit" placeholder="Unit" readonly style="width:110px;">
        </div>

        <button class="action" onclick="checkoutItem()" style="margin-top:12px;width:100%;">Checkout</button>
      </div>

      <div style="flex:1;max-height:400px;overflow-y:auto;background:#2f3949;padding:10px;border-radius:10px;">
        <h3>Checkout History</h3>
        <table>
          <thead><tr><th>Date</th><th>#</th><th>Name</th><th>Lot</th><th>Qty</th><th>Volume</th><th>Unit</th><th>User</th></tr></thead>
          <tbody id="checkoutLog"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="activity" class="card" style="display:none;">
    <h2>Activity Log</h2>
    <table><thead><tr><th>Date</th><th>Action</th><th>User</th></tr></thead><tbody id="activityLog"></tbody></table>
  </div>

  <div id="settings" class="card" style="display:none;">
    <h2>Settings</h2>
    <label><input type="checkbox" id="darkToggle" onchange="toggleDark()"> Dark Mode</label><br><br>
    <input id="s_newUser" placeholder="New Username"><br>
    <input id="s_newPass" placeholder="New Password" type="password" style="margin-top:10px;"><br>
    <button class="action" onclick="saveSettings()" style="margin-top:12px;">Save</button> </div>







<!-- EDIT MODAL -->
<div id="editModal" class="modal-overlay">
  <div class="modalContent">
    <h3>Edit Item <span id="editItemNum" style="font-weight:normal;font-size:12px;color:#cfeef0;margin-left:8px;"></span></h3>

    <label>Item Number</label>
    <input id="editNum" placeholder="Item Number">

    <label>Name</label>
    <input id="editName" placeholder="Name">

    <label>Lot</label>
    <input id="editLot" placeholder="Lot">

    <label>Exp</label>
    <input id="editExp" type="date">

    <label>Qty</label>
    <input id="editQty" type="number" placeholder="Qty">

    <label>Volume (per item)</label>
    <input id="editVolume" type="number" placeholder="e.g. 250 (leave blank if not applicable)">

    <label>Unit (optional)</label>
<select id="editUnit">
  <option value="">(none)</option>
  <option value="mL">mL</option>
  <option value="L">L</option>
  <option value="mg">mg</option>
  <option value="g">g</option>
  <option value="kg">kg</option>
  <option value="mm">mm</option>
  <option value="Units">Units</option>
</select>



<hr style="border:0;border-top:1px solid rgba(255,255,255,0.08);margin:14px 0;">
<div style="font-size:12px;opacity:.7;margin-bottom:4px;">
  Dashboard alerts (per item)
</div>

<label>
  Low stock warning
  <span style="opacity:.6;font-size:11px;">
    (dashboard alert when quantity â‰¤ this value)
  </span>
</label>
<input id="editLowStock" type="number" min="0" placeholder="Default: 100 items">

<label style="margin-top:10px;">
  Expiration warning
  <span style="opacity:.6;font-size:11px;">
    (dashboard alert when days remaining â‰¤ this value)
  </span>
</label>
<input id="editExpWarn" type="number" min="0" placeholder="Default: 90 days">

<label style="margin-top:10px;">
  <input type="checkbox" id="editInUse" checked>
  Currently In Use
</label>


     
    <div class="modalFooter" style="margin-top:14px">
      <button class="action" onclick="saveEditClicked()">Save</button>
      <button class="btn-delete" onclick="openConfirmModalForDelete()">Delete</button>
      <button class="btn-cancel" onclick="closeEdit()">Cancel</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div id="confirmModal" class="modal-overlay">
  <div class="modalContent">
    <h3>Confirm</h3>
    <div class="modalMessage" id="confirmMessage">Are you sure?</div>
    <div class="modalFooter" style="margin-top:14px;justify-content:center;">
      <button class="btn-cancel" onclick="closeConfirmModal()">No</button>
      <button class="btn-delete" id="confirmYesBtn">Yes</button>
    </div>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="successModal" class="modal-overlay">
  <div class="modalContent">
    <h3>Checked Out Successfully</h3>
    <div id="successDetails" style="color:#cfeef0;margin-top:10px;font-size:14px; white-space:pre-line;"></div>
    <div class="modalFooter" style="margin-top:14px;justify-content:center;">
      <button class="action" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>
</div>

<!-- small status -->
<div id="statusBar">Connectingâ€¦</div>

<!-- Firebase compat SDKs via script tags (no install) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* =====================
   Firebase config (use your project's config)
   ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyC7UIbf659fa178lEwY2NRi-fVS7X19V6s",
  authDomain: "inventory-system-98c5a.firebaseapp.com",
  databaseURL: "https://inventory-system-98c5a-default-rtdb.firebaseio.com",
  projectId: "inventory-system-98c5a",
  storageBucket: "inventory-system-98c5a.firebasestorage.app",
  messagingSenderId: "1033885491938",
  appId: "1:1033885491938:web:01f682ce830f70494df4bb",
  measurementId: "G-Y0E09S4FRD"
};

function updateCreateAccountVisibility(){
  const link = document.getElementById('createAccountLink');
  if(!link) return;

link.style.display = 'block';
}


function openDashPopup(type){



  const title = document.getElementById("dashPopupTitle");
if(!title) return;

  const body = document.getElementById("dashPopupBody");
  body.innerHTML = "";

  let items = [];
  let subtitle = "";

  if(type === "low"){
    title.textContent = "Low Stock Items";
    subtitle = "Using per-item low stock thresholds";
    items = inventory.filter(i =>
  Number(i.qty) <= Number(i.lowStock || 100)
);

  }

  if(type === "exp"){
    title.textContent = "Expiring Soon";
    subtitle = "Using per-item expiration warnings";
    items = inventory.filter(i=>{
      if(!i.exp) return false;
      const days =
  (new Date(i.exp) - new Date()) / 86400000;
return days <= Number(i.expWarn || 90);

    });
  }

if(type === "users"){
  title.textContent = "Users";
  body.innerHTML = "";

  if(!accounts || accounts.length === 0){
    body.innerHTML = "<div style='opacity:.7'>No users found</div>";
  } else {
    accounts.forEach(acc=>{
      const isOnline = presence[acc.u]?.online;
      const dot = isOnline ? "ðŸŸ¢" : "âš«";
      const status = isOnline ? "Online" : "Offline";

      const row = document.createElement("div");
      row.style.padding = "8px 4px";
      row.style.borderBottom = "1px solid rgba(255,255,255,0.06)";

      row.innerHTML = `
        <div style="font-weight:500">${dot} ${acc.u}</div>
        <div style="font-size:12px;opacity:.7">${status}</div>
      `;

      body.appendChild(row);
    });
  }

  // ðŸ”´ THIS LINE WAS MISSING
  document.getElementById("dashPopup").style.display = "flex";
  return;
}


  if(items.length === 0){
    body.innerHTML = `<div style="opacity:.7">No items found</div>`;
  } else {
    body.innerHTML = `
      <div style="font-size:12px;opacity:.7;margin-bottom:6px;">
        ${subtitle}
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="opacity:.8">
            <th style="text-align:left;padding:6px;">#</th>
            <th style="text-align:left;padding:6px;">Name</th>
            <th style="text-align:left;padding:6px;">Lot</th>
            <th style="text-align:left;padding:6px;">Qty</th>
            <th style="text-align:left;padding:6px;">Exp</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(i=>{
            const days = i.exp ? Math.floor((new Date(i.exp)-new Date())/(1000*60*60*24)) : "";
            const danger = (type==="exp" && days <= 7) || (type==="low" && i.qty <= 2);
            return `
              <tr style="color:${danger ? '#ff7777' : 'inherit'}">
                <td style="padding:6px;">${i.num}</td>
                <td style="padding:6px;">${i.name}</td>
                <td style="padding:6px;">${i.lot}</td>
                <td style="padding:6px;">${i.qty}</td>
                <td style="padding:6px;">${i.exp || '-'}</td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  document.getElementById("dashPopup").style.display = "flex";
}

/* Initialize Firebase */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* App state */
let inventory = [], checkoutHistory = [], accounts = [], activity = [], loggedIn = null;
let presence = {};

let keys = {};
let appSettings = { disableCreateAccount: false };


/* Helpers */
function escapeHtml(s){ if(s===undefined||s===null) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJs(s){ if(s===undefined||s===null) return ""; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1); }

const ROLE_POWER = {
  user: 1,
  microbiologist: 2,
  admin: 3,
  superadmin: 4
};

function isAdmin(){
  const acc = accounts.find(a => a.u === loggedIn);
  return acc && ROLE_POWER[acc.role] >= ROLE_POWER.admin;
}

function isSuperAdmin(){
  const acc = accounts.find(a => a.u === loggedIn);
  return acc && acc.role === "superadmin";
}


function updateAdminUI(){
  // hide admin sidebar button by default
  document.querySelectorAll(".adminOnly").forEach(b=>{
    b.style.display = isAdmin() ? "block" : "none";
  });

  const adminPanel = document.getElementById("adminPanel");
  const roleMgr = document.getElementById("roleManager");

  if(isAdmin()){
    adminPanel?.classList.remove("hidden");
    roleMgr?.classList.remove("hidden");
    populateRoleUsers();
    renderKeyLog();
  } else {
    adminPanel?.classList.add("hidden");
    roleMgr?.classList.add("hidden");
  }
}



function populateRoleUsers(){
  const sel = document.getElementById("roleUserSelect");
  if(!sel) return;

  sel.innerHTML = "";
  accounts.forEach(acc=>{
    const opt = document.createElement("option");
    opt.value = acc.u;
    opt.textContent = `${acc.u} (${acc.role || 'user'})`;
    sel.appendChild(opt);
  });
}

function changeUserRole(){
  const user = document.getElementById("roleUserSelect").value;
  const role = document.getElementById("roleSelect").value;

  const me = accounts.find(a => a.u === loggedIn);
  const target = accounts.find(a => a.u === user);

  if(!me || !target) return alert("User not found");

  // âŒ Admins cannot modify admins or superadmins
  if(me.role === "admin"){
    if(ROLE_POWER[target.role] >= ROLE_POWER.admin){
      return alert("Admins cannot modify other admins");
    }
  }

  // âŒ Only superadmin can assign admin or superadmin roles
  if(ROLE_POWER[role] >= ROLE_POWER.admin && !isSuperAdmin()){
    return alert("Only Super Admin can assign admin roles");
  }

  // âŒ Prevent removing the last superadmin
  if(target.role === "superadmin" && role !== "superadmin"){
    const count = accounts.filter(a => a.role === "superadmin").length;
    if(count <= 1){
      return alert("You cannot remove the last Super Admin");
    }
  }

  target.role = role;

  activity.push({
    date: new Date().toLocaleString(),
    action: `Changed role of ${user} â†’ ${role}`,
    user: loggedIn
  });

  saveAll();
  populateRoleUsers();
  alert("Role updated");
}





/* ---------- Presence (online/offline users) ---------- */
function setupPresence(username){
  const userStatusRef = db.ref('presence/' + username);
  const connectedRef = db.ref('.info/connected');

  connectedRef.on('value', snap=>{
    if(snap.val() === true){
      userStatusRef.onDisconnect().set({
        online: false,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });

      userStatusRef.set({
        online: true,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
    }
  });
}


/* UI refs (filled DOMContentLoaded) */
let loginPage, createPage, sidebarEl, main;
let r_itemNum, r_name, r_lot, r_exp, r_qty, r_volume, r_unit;
let c_search, c_dropdown, c_itemNum, c_name, c_lot, c_exp, c_qty, c_volume, c_unit;
let editModalEl, editNum, editName, editLot, editExp, editQty,
    editVolume, editUnit, editItemNum, editLowStock, editExpWarn;

let confirmModalEl, confirmMessage, successModalEl, successDetails;
let s_newUser, s_newPass, loginUser, loginPass, newUser, newPass;
const statusBar = document.getElementById('statusBar');

/* ---------- Firebase realtime listeners ---------- */
  db.ref('presence').on('value', snap=>{
    presence = snap.val() || {};
  });

function setupFirebaseListeners(){
  statusBar.textContent = 'Connecting to Firebaseâ€¦';

  db.ref('inventory').on('value', snap=>{
    const val = snap.val();
    if(!val) inventory = [];
    else if(Array.isArray(val)) inventory = val;
    else inventory = Object.values(val);
    updateAll();

    updateDashboard();
    statusBar.textContent = 'Connected â€” inventory synced';
  });

db.ref('keys').on('value', snap=>{
  keys = snap.val() || {};
});

db.ref('settings').on('value', snap=>{
    appSettings = snap.val() || { disableCreateAccount:false };
    // âš¡ call after DOM is ready
    setTimeout(updateCreateAccountVisibility, 50);
});




  db.ref('checkoutHistory').on('value', snap=>{
    const val = snap.val();
    checkoutHistory = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
    updateAll();
  });

  db.ref('accounts').on('value', snap=>{
    const val = snap.val();
    accounts = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
    updateUsernameSuggestions();
  });

  db.ref('activity').on('value', snap=>{
    const val = snap.val();
    activity = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
    updateAll();
  });

  db.ref('.info/connected').on('value', s => {
    if(s.val() === true) statusBar.textContent = 'Connected to Firebase';
    else statusBar.textContent = 'Offline / disconnected';
  });
}

/* Ensure object fields are safe before saving */
function sanitizeInventoryBeforeSave(){
  inventory = inventory.map(i => {
    return {
      ...i,
      // ensure qty is a number
      qty: (i.qty === undefined || i.qty === null) ? 0 : Number(i.qty),
      // ensure volume/unit are defined (empty allowed)
      volume: (i.volume === undefined || i.volume === null) ? "" : i.volume,
      unit: (i.unit === undefined || i.unit === null) ? "" : i.unit
    };
  });

  // also ensure checkoutHistory and activity entries are safe objects
  checkoutHistory = checkoutHistory.map(e => e || {});
  activity = activity.map(a => a || {});
}

/* Save all to Firebase */
function saveAll(){
  sanitizeInventoryBeforeSave();
  db.ref('inventory').set(inventory).catch(e=>console.error('save inventory',e));
  db.ref('checkoutHistory').set(checkoutHistory).catch(e=>console.error('save chk',e));
  db.ref('accounts').set(accounts).catch(e=>console.error('save acc',e));
  db.ref('activity').set(activity).catch(e=>console.error('save act',e));
  updateAll();
  updateUsernameSuggestions();
}

/* Username suggestions */
function updateUsernameSuggestions(){
  const dl = document.getElementById("userList"); if(!dl) return;
  dl.innerHTML = ""; accounts.forEach(acc=>{ const opt = document.createElement('option'); opt.value = acc.u; dl.appendChild(opt); });
}

/* Login / Create navigation */

function showCreate(){
  loginPage.style.display = 'none';
  createPage.style.display = 'flex';
}



function showLogin(){
  createPage.style.display = 'none';
  loginPage.style.display = 'flex';
}

function createAccount(){
  if(appSettings.disableCreateAccount)
    return alert('Account creation is disabled');

  const u = newUser.value.trim();
  const p = newPass.value;
  const k = newKey.value.trim();

  if(!u || !p || !k)
    return alert('All fields including key are required');

  if(accounts.find(a => a.u === u))
    return alert('Username already exists');

  const keyObj = keys[k];
  if(!keyObj || keyObj.used)
    return alert('Invalid or already-used key');

  const role = keyObj.role || 'user';

  // mark key as used
  keyObj.used = true;
  keyObj.claimedBy = u;
  keyObj.claimedAt = Date.now();

  accounts.push({ u, p, role });
  saveAll();

  db.ref('keys').set(keys);

  alert(`Account created as ${role}`);
  showLogin();
}



function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value;

  const a = accounts.find(x => x.u === u && x.p === p);
  if(!a) return alert('Invalid login');

  loggedIn = u;

  // ðŸ”´ START presence tracking
  setupPresence(u);

  // ðŸ”¹ Update sidebar user display
  const nameEl = document.getElementById("sidebarUsername");
  const roleEl = document.getElementById("sidebarRole");

  if(nameEl) nameEl.textContent = u;
  if(roleEl) roleEl.textContent = `(${a.role || "user"})`;

  sidebarEl.style.display = 'flex';
  main.style.display = 'block';
  loginPage.style.display = 'none';

  showPage('dashboard');
  updateAll();
  updateAdminUI();
}


/* Navigation */
function showPage(p){

if(p === "admin" && !isAdmin()){
  alert("Admins only");
  return;
}

  const pages = [
  "dashboard",
  "inventory",
  "materials",
  "restock",
  "checkout",
  "activity",
  "settings",
  "admin" // âœ… ADD
];


  pages.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = "none";
  });

  const activePage = document.getElementById(p);
  if(activePage) activePage.style.display = "block";

  document.querySelectorAll(".sidebar-btn").forEach(btn=>{
    btn.classList.remove("active");
  });

  const activeBtn = document.getElementById("sb_" + p);
  if(activeBtn) activeBtn.classList.add("active");

  if(p === "dashboard"){
    updateDashboard();
  }




updateAdminUI();

}

function updateDashboard(){
  const lowItems = inventory.filter(i =>
  Number(i.qty) <= Number(i.lowStock ?? 100)
);


  const expItems = inventory.filter(i=>{
    if(!i.exp) return false;
    const days = (new Date(i.exp) - new Date()) / 86400000;
    return days <= Number(i.expWarn || 90)
  });

  const totalUsers = accounts.length;

  document.getElementById("dash_low").textContent = lowItems.length;
  document.getElementById("dash_exp").textContent = expItems.length;
  document.getElementById("dash_items").textContent = inventory.length;
  document.getElementById("dash_users").textContent = totalUsers;

  document.getElementById("circle_low").style.background =
    `conic-gradient(#ff5555 ${Math.min(lowItems.length * 40, 360)}deg,#0b2e40 0deg)`;

  document.getElementById("circle_exp").style.background =
    `conic-gradient(#ffaa00 ${Math.min(expItems.length * 40, 360)}deg,#0b2e40 0deg)`;

  document.getElementById("circle_items").style.background =
    `conic-gradient(var(--muted) ${Math.min(inventory.length * 30, 360)}deg,#0b2e40 0deg)`;

  document.getElementById("circle_users").style.background =
    `conic-gradient(#7ad7ff ${Math.min(totalUsers * 60, 360)}deg,#0b2e40 0deg)`;
}

  
/* Dark mode */
function toggleDark(){ document.body.classList.toggle('dark'); }

/* Update UI tables */
function updateAll(){
  // inventory table
  const I = document.getElementById('inventoryTable'); I.innerHTML = "";
  (inventory || []).filter(i => i.inUse !== false).forEach(i=>{
  const num = escapeHtml(String(i.num||""));
  const name = escapeHtml(i.name||"");
  const lot = escapeHtml(String(i.lot||""));
  const exp = escapeHtml(String(i.exp||""));
  const qty = Number(i.qty) || 0;
  const volume = escapeHtml(String(i.volume||""));
  const unit = escapeHtml(String(i.unit||""));
  I.innerHTML += `<tr>
    <td>${num}</td>
    <td>${name}</td>
    <td>${lot}</td>
    <td>${exp}</td>
    <td>${qty}</td>
    <td>${volume}</td>
    <td>${unit}</td>
  </tr>`;
});
  // materials table with edit buttons
  const M = document.getElementById('materialsTable'); M.innerHTML = "";
  (inventory || []).filter(i => i.inUse !== false).forEach(i=>{
  const num = escapeHtml(String(i.num||""));
  const name = escapeHtml(i.name||"");
  const lot = escapeHtml(String(i.lot||""));
  const exp = escapeHtml(String(i.exp||""));
  const qty = Number(i.qty) || 0;
  const volume = escapeHtml(String(i.volume||""));
  const unit = escapeHtml(String(i.unit||""));
  M.innerHTML += `<tr>
    <td>${num}</td>
    <td>${name}</td>
    <td>${lot}</td>
    <td>${exp}</td>
    <td>${qty}</td>
    <td>${volume}</td>
    <td>${unit}</td>
    <td><button class="actionSmall" onclick="editItem('${escapeJs(String(i.num||""))}')">Edit</button></td>
  </tr>`;
});

  // checkout history (guard against broken entries)
  const C = document.getElementById('checkoutLog'); C.innerHTML = "";
  (checkoutHistory || []).forEach(l=>{
    if(!l) return;
    const date = escapeHtml(l.date || "");
    const num = escapeHtml(String(l.num||""));
    const name = escapeHtml(l.name||"");
    const lot = escapeHtml(String(l.lot||""));
    const qty = Number(l.qty) || 0;
    const volume = escapeHtml(String(l.volume||""));
    const unit = escapeHtml(String(l.unit||""));
    const user = escapeHtml(l.user||"");
    C.innerHTML += `<tr><td>${date}</td><td>${num}</td><td>${name}</td><td>${lot}</td><td>${qty}</td><td>${volume}</td><td>${unit}</td><td>${user}</td></tr>`;
  });

  // activity log
  const A = document.getElementById('activityLog'); A.innerHTML = "";
  ([...activity].reverse() || []).forEach(a=>{
    if(!a) return;
    const date = escapeHtml(a.date||"");
    const action = escapeHtml(a.action||"");
    const user = escapeHtml(a.user||"");
    A.innerHTML += `<tr><td>${date}</td><td>${action}</td><td>${user}</td></tr>`;
  });
}

/* Restock */
function restock(){
  const num = String((r_itemNum.value||"").trim());
  const name = (r_name.value||"").trim();
  const lot = (r_lot.value||"").trim();
  const exp = r_exp.value;
  const qtyToAdd = Number(r_qty.value) || 0;
  const volumeInput = (r_volume.value !== "") ? Number(r_volume.value) : "";
  const unitInput = (r_unit.value||"").trim() || "";

  if(!num || !name || !lot || !exp || !qtyToAdd) return alert('Enter all required fields (qty must be > 0)');

  let it = inventory.find(x=>String(x.num)===num);
  if(it){
  it.qty = (Number(it.qty) || 0) + Number(qtyToAdd);
  if(volumeInput !== "") it.volume = volumeInput;
  if(unitInput) it.unit = unitInput;
  it.inUse = true;  // Reactivate item if previously inactive
} else {
  it = { num, name, lot, exp, qty: Number(qtyToAdd), volume: (volumeInput !== "" ? volumeInput : ""), unit: unitInput, inUse: true };
  inventory.push(it);
}

  activity.push({ date: new Date().toLocaleString(), action: `Restocked ${qtyToAdd}${it.unit?(' Ã— '+(it.volume?it.volume+' '+it.unit:it.unit)) : ''} of ${num}`, user: loggedIn || 'system' });
  saveAll();
  alert('Restocked');
}

/* Search dropdown (matches name, number, lot) */
function updateDropdown(){
  const v = (c_search.value || "").trim().toLowerCase();
  const dd = document.getElementById('c_dropdown');
  dd.innerHTML = "";
  if(!v){ dd.style.display = 'none'; return; }
  const m = (inventory || []).filter(i =>
  i.inUse !== false && (
    (i.name||"").toLowerCase().includes(v) ||
    String(i.num||"").toLowerCase().includes(v) ||
    String(i.lot||"").toLowerCase().includes(v)
  )
);
  m.forEach(i=>{
    const o = document.createElement('option');
    o.value = i.num;
    o.text = `${i.name} (${i.num})`;
    dd.appendChild(o);
  });
  dd.style.display = m.length ? 'block' : 'none';
}

/* Select item from dropdown */
function selectItem(){
  const selected = c_dropdown.value;
  const item = (inventory || []).find(x=>String(x.num)===String(selected));
  if(!item) return;
  c_itemNum.value = item.num;
  c_name.value = item.name;
  c_lot.value = item.lot;
  c_exp.value = item.exp;
  c_qty.value = "";
  c_volume.value = item.volume || "";
  c_unit.value = item.unit || "";
}

/* Checkout */
function checkoutItem(){
  const num = String((c_itemNum.value||"").trim());
  const qty = Number(c_qty.value);
  if(!num) return alert('Select an item');
  if(!qty || qty <= 0) return alert('Enter a valid qty');

  const item = (inventory || []).find(x=>String(x.num)===num);
  if(!item) return alert('Item not found');
  if(Number(item.qty) < qty) return alert('Not enough stock');

  item.qty = Number(item.qty) - qty;

  checkoutHistory.push({
    date: new Date().toLocaleString(),
    num,
    name: item.name,
    lot: item.lot,
    exp: item.exp,
    qty,
    volume: item.volume || "",
    unit: item.unit || "",
    user: loggedIn || 'system'
  });

  activity.push({ date: new Date().toLocaleString(), action: `Checked out ${qty}${item.unit?(' Ã— '+(item.volume?item.volume+' '+item.unit:item.unit)) : ''} of ${num}`, user: loggedIn || 'system' });

  saveAll();
  showSuccessPopup(item, qty);
  c_qty.value = "";
}

/* Success popup */
function showSuccessPopup(item, qty){
  // build the details text (multiline)
  successDetails.innerText = `${item.name}\nLot: ${item.lot}\nExp: ${item.exp}\nChecked out: ${qty}${item.unit?(' â€” '+(item.volume?item.volume+' '+item.unit:item.unit)) : ''}`;
  successModalEl.style.display = 'flex';
}

/* Close success */
function closeSuccessModal(){ successModalEl.style.display = 'none'; }

/* Outside click closures (set up after DOM ready) */
function setupOutsideClickClose(){
  // success popup - click outside to close
  successModalEl.addEventListener('mousedown', e=>{
    if(e.target === successModalEl) closeSuccessModal();
  });
  // edit modal - click outside to close (acts like cancel)
  editModalEl.addEventListener('mousedown', e=>{
    if(e.target === editModalEl) closeEdit();
  });
  // confirm modal - click outside to close (acts like cancel)
  confirmModalEl.addEventListener('mousedown', e=>{
    if(e.target === confirmModalEl) closeConfirmModal();
  });
}

/* Edit item */
let editTarget = null;
function editItem(num){
  editTarget = (inventory || []).find(i=>String(i.num)===String(num));
  if(!editTarget) return alert('Item not found');

  editNum.value = editTarget.num || "";
  editName.value = editTarget.name || "";
  editLot.value = editTarget.lot || "";
  editExp.value = editTarget.exp || "";
  editQty.value = editTarget.qty || 0;
  editVolume.value = editTarget.volume || "";
  editUnit.value = editTarget.unit || "";
  editItemNum.textContent = '#'+ (editTarget.num || "");
editLowStock.value = editTarget.lowStock ?? 100;
editExpWarn.value = editTarget.expWarn ?? 90;
editInUse.checked = (editTarget.inUse !== false);  // default true if undefined

  editModalEl.style.display = 'flex';
}

function saveEditClicked(){
  if(!editTarget) return;

  editTarget.num = editNum.value.trim();
  editTarget.name = editName.value.trim();
  editTarget.lot = editLot.value.trim();
  editTarget.exp = editExp.value;
  editTarget.qty = Number(editQty.value) || 0;
  editTarget.volume = editVolume.value !== "" ? Number(editVolume.value) : "";
  editTarget.unit = editUnit.value || "";

  editTarget.lowStock = Number(editLowStock.value) || 100;
  editTarget.expWarn = Number(editExpWarn.value) || 90;
editTarget.inUse = editInUse.checked;

  saveAll();
  closeEdit();
}



  
function closeEdit(){ editModalEl.style.display = 'none'; editTarget = null; }

/* Delete */
function openConfirmModalForDelete(){ if(!editTarget) return; openConfirmModal(`Delete item ${escapeHtml(editTarget.num)} (${escapeHtml(editTarget.name)})? This cannot be undone.`, deleteItem); }
function deleteItem(){ if(!editTarget) return; inventory = inventory.filter(i => i.num !== editTarget.num); activity.push({ date: new Date().toLocaleString(), action: `Deleted item ${editTarget.num} (${editTarget.name})`, user: loggedIn || 'system' }); saveAll(); closeEdit(); alert('Item deleted.'); }

/* Confirm modal */
function openConfirmModal(message, yesCallback){
  confirmMessage.textContent = message;
  confirmModalEl.style.display = 'flex';
  const oldBtn = document.getElementById('confirmYesBtn');
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);
  newBtn.onclick = ()=>{ try{ yesCallback(); }catch(e){ console.error(e); } closeConfirmModal(); };
}
function closeConfirmModal(){ confirmModalEl.style.display = 'none'; }

/* Settings */
function saveSettings(){
  const acc = accounts.find(a=>a.u === loggedIn);
  if(!acc) return alert('No account found');

  const u = s_newUser.value.trim();
  const p = s_newPass.value;
  const oldUser = acc.u;

  if(u){
    if(accounts.find(a=>a.u===u && a!==acc))
      return alert('Username already taken');

    acc.u = u;
    loggedIn = u;

    activity.push({
      date: new Date().toLocaleString(),
      action: `Changed username from "${oldUser}" â†’ "${u}"`,
      user: loggedIn
    });
  }

  if(p){
    acc.p = p;
    activity.push({
      date: new Date().toLocaleString(),
      action: `Changed password`,
      user: loggedIn
    });
  }

  saveAll();
  alert('Saved');
}


  

/* ===========================
   ADMIN â€“ KEY & ACCOUNT CONTROL
   =========================== */

function generateKey(){
  if(!isSuperAdmin()){
    return alert("Only Super Admin can generate keys");
  }


  const roleSelect = document.getElementById("keyRoleSelect");
  const role = roleSelect ? roleSelect.value : "user";

  // Safety: prevent accidental admin key creation
  if(role === "admin"){
    if(!confirm("âš ï¸ You are generating an ADMIN key. Continue?")){
      return;
    }
  }

  const key =
    Math.random().toString(36).substring(2,8).toUpperCase() +
    "-" +
    Math.random().toString(36).substring(2,6).toUpperCase();

  keys[key] = {
    role,
    createdBy: loggedIn,
    createdAt: Date.now(),
    claimedBy: null,
    claimedAt: null,
    used: false
  };

  db.ref("keys").set(keys);
  renderKeyLog();
}

function toggleCreateAccounts(disabled){
  if(!isAdmin()) return alert("Admins only");

  appSettings.disableCreateAccount = disabled;
  db.ref("settings").set(appSettings);
}


function renderKeyLog(){
  const el = document.getElementById("keyLog");
  if(!el) return;

  el.innerHTML = "";

  Object.entries(keys || {}).forEach(([k,v])=>{
    const row = document.createElement("div");
    row.style.marginBottom = "6px";

    row.innerHTML = `
      <div><b>${k}</b> â€” ${v.role}</div>
      <div style="font-size:11px;opacity:.7">
        Created by ${v.createdBy}
        ${v.used ? `â€¢ Claimed by ${v.claimedBy}` : "â€¢ Unused"}
      </div>
    `;

    el.appendChild(row);
  });
}


/* Initial demo / ensure data */
function ensureInitialData(){
  db.ref('inventory').once('value').then(snap=>{
    if(!snap.exists()){
      const demo = [
        { num:'001', name:'Widget A', lot:'L100', exp:'2026-12-31', qty:50, volume:250, unit:'mL' },
        { num:'002', name:'Widget B', lot:'L200', exp:'2024-08-15', qty:20, volume:90, unit:'mm' }
      ];
      db.ref('inventory').set(demo);
    }
  });
  db.ref('accounts').once('value').then(snap=>{
  if(!snap.exists()){
    db.ref('accounts').set([
      { u:'admin', p:'admin', role:'superadmin' }
    ]);
  }
});

  db.ref('checkoutHistory').once('value').then(snap=>{ if(!snap.exists()) db.ref('checkoutHistory').set([]); });
  db.ref('activity').once('value').then(snap=>{ if(!snap.exists()) db.ref('activity').set([]); });
}

/* DOM ready: wire elements and start listeners */
document.addEventListener('DOMContentLoaded', ()=>{
  // UI refs
  loginPage = document.getElementById('loginPage');
  createPage = document.getElementById('createPage');
  sidebarEl = document.getElementById('sidebar');
  main = document.getElementById('main');

  r_itemNum = document.getElementById('r_itemNum');
  r_name = document.getElementById('r_name');
  r_lot = document.getElementById('r_lot');
  r_exp = document.getElementById('r_exp');
  r_qty = document.getElementById('r_qty');
  r_volume = document.getElementById('r_volume');
  r_unit = document.getElementById('r_unit');

  c_search = document.getElementById('c_search');
  c_dropdown = document.getElementById('c_dropdown');
  c_itemNum = document.getElementById('c_itemNum');
  c_name = document.getElementById('c_name');
  c_lot = document.getElementById('c_lot');
  c_exp = document.getElementById('c_exp');
  c_qty = document.getElementById('c_qty');
  c_volume = document.getElementById('c_volume');
  c_unit = document.getElementById('c_unit');

  editModalEl = document.getElementById('editModal');
  editNum = document.getElementById('editNum');
  editName = document.getElementById('editName');
  editLot = document.getElementById('editLot');
  editExp = document.getElementById('editExp');
  editQty = document.getElementById('editQty');
  editVolume = document.getElementById('editVolume');
  editUnit = document.getElementById('editUnit');
editLowStock = document.getElementById('editLowStock');
editExpWarn = document.getElementById('editExpWarn');

  editItemNum = document.getElementById('editItemNum');

  confirmModalEl = document.getElementById('confirmModal');
  confirmMessage = document.getElementById('confirmMessage');

  successModalEl = document.getElementById('successModal');
  successDetails = document.getElementById('successDetails');

  s_newUser = document.getElementById('s_newUser');
  s_newPass = document.getElementById('s_newPass');
  loginUser = document.getElementById('loginUser');
  loginPass = document.getElementById('loginPass');
  newUser = document.getElementById('newUser');
newPass = document.getElementById('newPass');
newKey  = document.getElementById('newKey'); // âœ… REQUIRED


  sidebarEl.style.display = 'none';
  main.style.display = 'none';
  loginPage.style.display = 'flex';

  setupFirebaseListeners();
  ensureInitialData();
  setupOutsideClickClose();
});

/* Expose functions for onclick handlers */

window.generateKey = generateKey;
window.toggleCreateAccounts = toggleCreateAccounts;

window.login = login;
window.showCreate = showCreate;
window.showLogin = showLogin;
window.createAccount = createAccount;
window.showPage = showPage;
window.updateDropdown = updateDropdown;
window.selectItem = selectItem;
window.checkoutItem = checkoutItem;
window.restock = restock;
window.editItem = editItem;
window.saveEditClicked = saveEditClicked;
window.openConfirmModalForDelete = openConfirmModalForDelete;
window.closeEdit = closeEdit;
window.closeConfirmModal = closeConfirmModal;
window.saveSettings = saveSettings;
window.toggleDark = toggleDark;
window.updateUsernameSuggestions = updateUsernameSuggestions;
window.closeSuccessModal = closeSuccessModal;
function closeDashPopup(){
  const el = document.getElementById("dashPopup");
  if(el) el.style.display = "none";
}


/* Dashboard */
window.updateDashboard = updateDashboard;
window.openDashPopup = openDashPopup;
window.closeDashPopup = closeDashPopup;



</script>

<!-- DASHBOARD POPUP -->
<div id="dashPopup" class="modal-overlay" style="display:none;">
  <div class="modalContent">
    <h3 id="dashPopupTitle"></h3>

    <div id="dashPopupBody" style="margin-top:12px; max-height:300px; overflow-y:auto;">
      <!-- items injected here -->
    </div>

    <div class="modalFooter" style="margin-top:14px; justify-content:center;">
      <button class="action" onclick="closeDashPopup()">Close</button>
    </div>
  </div>
</div>


</body>
</html>
